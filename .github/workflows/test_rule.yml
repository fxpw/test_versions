name: Validate PR branch flow

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Проверка веток по правилам
        run: |
          base="${{ github.event.pull_request.base.ref }}"
          head="${{ github.event.pull_request.head.ref }}"

          echo "Целевая (base): $base"
          echo "Источник (head): $head"

          # 1. premain > main
          if [ "$base" == "main" ]; then
            if [ "$head" != "premain" ]; then
              echo "Ошибка: Из premain можно заливать только в main."
              exit 1
            fi
          # 2. dev > premain
          elif [ "$base" == "dev" ]; then
            if [ "$head" != "premain" ]; then
              echo "Ошибка: Из dev можно заливать только в premain."
              exit 1
            fi
          # 3. (issue_id)_local_(backend|frontend) > (issue_id)_local
          elif echo "$base" | grep -E '^([0-9A-Za-z]+)_local$'; then
            base_issue="${base%_local}"
            if [ "$head" == "$base" ]; then
              echo "OK: Ветку $head можно мерджить только в $base."
            elif echo "$head" | grep -E "^${base_issue}_local_(backend|frontend)$"; then
              echo "OK: Ветка $head разрешена для мерджа в $base."
            else
              echo "Ошибка: Можно мерджить только ветку $base или ${base_issue}_local_(backend|frontend)."
              exit 1
            fi
          # 4. (issue_id)_local > dev
          elif echo "$base" | grep -E '^([0-9A-Za-z]+)_local$'; then
            # Проверяем, что base — это именно ветка вида (issue_id)_local
            # Тогда head должна быть только в dev
            if [ "$base" == "$head" ]; then
              echo "OK: Можно мерджить ветку $base в 'dev'."
            elif [ "$head" == "dev" ]; then
              echo "OK: Ветка $base может мерджиться в dev."
            else
              echo "Ошибка: Ветка $base может мерджиться только в dev."
              exit 1
            fi
          else
            echo "Ошибка: Базовая ветка $base не подходит под правила."
            exit 1
          fi
